/*!
 * Synote Media Fragment Player
 *
 * Playing Media Fragment URIs using mediaelementjs player
 *  
 * Copyright 2013 Yunjia Li, University of Southampton (http://www.ecs.soton.ac.uk/people/yl2)
 * Licensed under the MIT License.
 *
 */var MediaFragments=function(c){if(!Array.prototype.forEach)Array.prototype.forEach=function(g,b){if(this===void 0||this===null)throw new TypeError;var a=Object(this),d=a.length>>>0;if(typeof g!=="function")throw new TypeError;for(var h=0;h<d;h++)h in a&&g.call(b,a[h],h,a)};var m=function(g){console.log("Media Fragments URI Parsing Warning: "+g)},r={t:function(g){var b=g.split(",");if(b.length>2)return false;var a=b[0]?b[0]:"";b=b[1]?b[1]:"";if(a===""&&b===""||a&&!b&&g.indexOf(",")!==-1)return false;
var d=/^((npt\:)?((\d+\:(\d\d)\:(\d\d))|((\d\d)\:(\d\d))|(\d+))(\.\d*)?)?$/;if(d.test(a)&&d.test(b)){a=a.replace(/^npt\:/,"");a=a.replace(/\.$/,"");b=b.replace(/\.$/,"");d=function(e){if(e==="")return false;var i,f;e=e.split(":");i=e.length;if(i===3){i=parseInt(e[0],10);f=parseInt(e[1],10);e=parseFloat(e[2])}else if(i===2){i=0;f=parseInt(e[0],10);e=parseFloat(e[1])}else if(i===1){f=i=0;e=parseFloat(e[0])}else return false;if(i>23){m("Please ensure that hours <= 23.");return false}if(f>59){m("Please ensure that minutes <= 59.");
return false}if(e>=60){m("Please ensure that seconds < 60.");return false}return i*3600+f*60+e};var h=d(a),j=d(b);if(a&&b)if(h<j)return{value:g,unit:"npt",start:a,end:b,startNormalized:h,endNormalized:j};else{m("Please ensure that start < end.");return false}else if(d(a)!==false||d(b)!==false)return{value:g,unit:"npt",start:a,end:b,startNormalized:h===false?"":h,endNormalized:j===false?"":j};else{m("Please ensure that start or end are legal.");return false}}d=/^(\d+\:\d\d\:\d\d(\:\d\d(\.\d\d)?)?)?$/;
h=a.replace(/^(smpte(-25|-30|-30-drop)?).*/,"$1");a=a.replace(/^smpte(-25|-30|-30-drop)?\:/,"");if(d.test(a)&&d.test(b)){d=function(e){if(e==="")return false;var i,f,k,o;e=e.split(":");i=e.length;if(i===3){i=parseInt(e[0],10);f=parseInt(e[1],10);k=parseInt(e[2],10);o=e=0}else if(i===4){i=parseInt(e[0],10);f=parseInt(e[1],10);k=parseInt(e[2],10);if(e[3].indexOf(".")===-1){e=parseInt(e[3],10);o=0}else{o=e[3].split(".");e=parseInt(o[0],10);o=parseInt(o[1],10)}}else return false;if(i>23){m("Please ensure that hours <= 23.");
return false}if(f>59){m("Please ensure that minutes <= 59.");return false}if(k>59){m("Please ensure that seconds <= 59.");return false}return i*3600+f*60+k+e*0.001+o*1.0E-6};if(a&&b)if(d(a)<d(b))return{value:g,unit:h,start:a,end:b};else{m("Please ensure that start < end.");return false}else if(d(a)!==false||d(b)!==false)return{value:g,unit:h,start:a,end:b};else{m("Please ensure that start or end are legal.");return false}}d=/^((\d{4})(-(\d{2})(-(\d{2})(T(\d{2})\:(\d{2})(\:(\d{2})(\.(\d+))?)?(Z|(([-\+])(\d{2})\:(\d{2})))?)?)?)?)?$/;
a=a.replace("clock:","");if(d.test(a)&&d.test(b))if(a&&b&&!isNaN(Date.parse("2009-07-26T11:19:01Z")))if(Date.parse(a)<=Date.parse(b))return{value:g,unit:"clock",start:a,end:b};else{m("Please ensure that start < end.");return false}else return{value:g,unit:"clock",start:a,end:b};m("Invalid time dimension.");return false},xywh:function(g){var b=/^percent\:\d+,\d+,\d+,\d+$/,a=g.replace(/(pixel|percent)\:/,"").split(","),d=a[0],h=a[1],j=a[2];a=a[3];if(/^(pixel\:)?\d+,\d+,\d+,\d+$/.test(g))if(j>0&&a>0)return{value:g,
unit:"pixel",x:d,y:h,w:j,h:a};else{m("Please ensure that w > 0 and h > 0");return false}else{if(b.test(g)){if(function(e,i,f,k){if(!(0<=e&&e<=100)){m("Please ensure that 0 <= x <= 100.");return false}if(!(0<=i&&i<=100)){m("Please ensure that 0 <= y <= 100.");return false}if(!(0<=f&&f<=100)){m("Please ensure that 0 <= w <= 100.");return false}if(!(0<=k&&k<=100)){m("Please ensure that 0 <= h <= 100.");return false}return true}(d,h,j,a))return{value:g,unit:"percent",x:d,y:h,w:j,h:a};m("Invalid percent selection.")}else m("Invalid spatial dimension.");
return false}},track:function(g){return{value:g,name:g}},id:function(g){return{value:g,name:g}},chapter:function(g){return{value:g,chapter:g}}},q=function(g){var b={};g.split("&").forEach(function(a){var d=a.indexOf("=");if(!(d<1)){var h=[a.substring(0,d),a.substring(d+1)];if(h[1]){a=decodeURIComponent(h[0]);d=r[a];h=decodeURIComponent(h[1]);if(d)if(h=d(h)){b[a]||(b[a]=[]);if(a!=="t")b[a].push(h);else b[a][0]=h}}}});return b};return{parse:function(g){return MediaFragments.parseMediaFragmentsUri(g)},
parseMediaFragmentsUri:function(g){g=g?g:c.location.href;var b=g.indexOf("#"),a=g.indexOf("?"),d=b!==-1?b:g.length;a=a!==-1?g.substring(a+1,d):"";g=b!==-1?g.substring(b+1):"";var h=q(a),j=q(g);return{query:h,hash:j,toString:function(){var e=function(i,f){var k="\n["+i+"]:\n";if(!Object.keys)Object.keys=function(o){if(o!==Object(o))throw new TypeError("Object.keys called on non-object");var n=[],l;for(l in o)Object.prototype.hasOwnProperty.call(o,l)&&n.push(l);return n};Object.keys(f).forEach(function(o){k+=
"  * "+o+":\n";f[o].forEach(function(n){k+="    [\n";Object.keys(n).forEach(function(l){k+="      - "+l+": "+n[l]+"\n"});k+="   ]\n"})});return k};return e("Query",h)+e("Hash",j)}}}}}(window),smfplayer=smfplayer||{};smfplayer.version="v0.2";
smfplayer.utils={durationMax:4294967295,audioList:["wma","m4a","mp3","wav","mpeg"],videoList:["mp4","m4v","mov","wmv","flv","ogg","webm"],isYouTubeURL:function(c,m){return c.match(/^https?:\/\/(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/)?m!==true?RegExp.$1:true:false},isDailyMotionURL:function(c){return c.match(/^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/)!==null},isVimeoURL:function(c){return c.match(/^.+vimeo.com\/(\d+)?/)!==null},isValidURL:function(c){return/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?(#([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)?$/.test(c)},
isiPad:function(){return navigator.userAgent.match(/iPad/i)!=null},getTemporalMF:function(c){var m=c.start?c.startNormalized:0;c=c.end?c.endNormalized:this.durationMax;m=parseFloat(m);c=parseFloat(c);return{st:m,et:c}},getSpatialMF:function(){}};
(function(c,m){function r(e,i){var f=decodeURI(e);f=d[i?"strict":"loose"].exec(f);for(var k={attr:{},param:{},seg:{}},o=14;o--;)k.attr[b[o]]=f[o]||"";k.param.query={};k.param.fragment={};k.attr.query.replace(h,function(n,l,p){if(l)k.param.query[l]=p});k.attr.fragment.replace(j,function(n,l,p){if(l)k.param.fragment[l]=p});k.seg.path=k.attr.path.replace(/^\/+|\/+$/g,"").split("/");k.seg.fragment=k.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");k.attr.base=k.attr.host?k.attr.protocol+"://"+k.attr.host+
(k.attr.port?":"+k.attr.port:""):"";return k}function q(e){e=e.tagName;if(e!==m)return g[e.toLowerCase()];return e}var g={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},b=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],a={anchor:"fragment"},d={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},h=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,j=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;c.fn.url=function(e){var i="";if(this.length)i=c(this).attr(q(this[0]))||"";return c.url(i,e)};c.url=function(e,i){if(arguments.length===1&&e===true){i=true;e=m}i=i||false;e=e||window.location.toString();return{data:r(e,i),attr:function(f){f=
a[f]||f;return f!==m?this.data.attr[f]:this.data.attr},param:function(f){return f!==m?this.data.param.query[f]:this.data.param.query},fparam:function(f){return f!==m?this.data.param.fragment[f]:this.data.param.fragment},segment:function(f){if(f===m)return this.data.seg.path;else{f=f<0?this.data.seg.path.length+f:f-1;return this.data.seg.path[f]}},fsegment:function(f){if(f===m)return this.data.seg.fragment;else{f=f<0?this.data.seg.fragment.length+f:f-1;return this.data.seg.fragment[f]}}}}})(jQuery);
(function(c){var m={width:640,height:480,originalWidth:320,originalHeight:240,isVideo:true,mfAlwaysEnabled:false,spatialEnabled:true,spatialStyle:{},spatialOverlay:false,temporalHighlight:false,autoStart:true,tracks:[]},r={init:function(g){var b=this;this.pause=function(){c(this).data("smfplayer").smfplayer!==undefined?c(this).data("smfplayer").smfplayer.pause():console.error("smfplayer hasn't been initalised")};this.play=function(){var a=c(this).data("smfplayer").smfplayer;a!==undefined?a.play():
console.error("smfplayer hasn't been initalised")};this.playmf=function(){var a=c(this).data("smfplayer");if(a===undefined)setTimeout(function(){b.playmf()},100);else{var d=0;if(!c.isEmptyObject(a.mfjson.hash))d=smfplayer.utils.getTemporalMF(a.mfjson.hash.t[0]).st;var h=c(this).data("smfplayer").smfplayer;this.setPosition(d*1E3);h.media.paused&&h.play();a.mfreplay=true}};this.showxywh=function(a){var d=c(this).data("smfplayer");if(d===undefined)setTimeout(function(){b.showxywh(a)},100);else if(!(c.isEmptyObject(a)||
d.settings.spatialEnabled!==true)){var h,j;if(d.settings.xywhoverlay===undefined){this.addClass("smfplayer-container");h=this.find(".mejs-container");j=c("<div>").addClass("overlay-container");j.height(d.settings.height).width(d.settings.width).appendTo(h);h=c("<div/>").css(d.settings.spatialStyle).addClass("smfplayer-overlay").appendTo(j);if(d.settings.spatialOverlay){var e=c("<div>").addClass("smfplayer-overlay-dark"),i=e.clone(),f=e.clone(),k=e.clone();e.css({top:0,left:0,height:a.y,width:"100%"});
i.css({top:a.y+"px",left:0,height:a.h,width:a.x});f.css({top:a.y+"px",right:0,height:a.h,width:d.settings.width-(parseInt(a.x)+parseInt(a.w))});k.css({bottom:0,left:0,height:d.settings.height-(parseInt(a.y)+parseInt(a.h)),width:"100%"});j.append(e,i,f,k);h=h.add(j)}var o=this;h.click(function(){var n=o.getMeplayer();n.media.paused?n.play():n.pause()});d.settings.xywhoverlay=h}else h=d.settings.xywhoverlay;j=a.x;e=a.y;i=a.w;f=a.h;if(a.unit==="percent"){j=Math.floor(j/100*d.settings.width);i=Math.floor(i/
100*d.settings.width);e=Math.floor(e/100*d.settings.height);f=Math.floor(f/100*d.settings.height)}h.filter(".smfplayer-overlay").css({width:i,height:f,top:e+"px",left:j+"px"});h.show()}};this.highlight=function(){var a=b.getDuration();a==0&&setTimeout(function(){return b.highlight},500);var d=c(".mejs-time-total",b),h=c(".mfHighlight",d);if(!h.length>0)h=c("<span>").addClass("mfHighlight");var j=b.getMFJson().hash.t||b.getMFJson().query.t;if(typeof j!="undefined"){var e=j[0].startNormalized*1E3;j=
j[0].endNormalized*1E3;j=j>0?j:a;h.css("left",e*100/a+"%").width((j-e)*100/a+"%").appendTo(d).show()}return this};this.hidexywh=function(){var a=c(this).data("smfplayer");if(a===undefined)setTimeout(function(){b.hidexywh()},100);else a.settings.xywhoverlay!==undefined&&a.settings.xywhoverlay.hide()};this.load=function(){var a=c(this).data("smfplayer").smfplayer;a!==undefined?a.load():console.error("smfplayer hasn't been initalised")};this.getPosition=function(){var a=c(this).data("smfplayer").smfplayer;
if(a)return parseInt(a.getCurrentTime()*1E3);else{console.error("smfplayer hasn't been initalised");return-1}};this.setPosition=function(a){var d=c(this).data("smfplayer").smfplayer;a=a?a:0;if(d!==undefined)b.getPosition()<=0?setTimeout(function(){b.setPosition(a)},100):d.setCurrentTime(a/1E3);else console.error("smfplayer hasn't been initalised")};this.getDuration=function(){var a=c(this).data("smfplayer").smfplayer;if(a!==undefined)return a.media.duration*1E3;else{console.error("smfplayer hasn't been initalised");
return-1}};this.getMFJson=function(){return c(this).data("smfplayer").mfjson};this.setmf=function(a){a=a.indexOf("#")==-1?"#"+a:a;window.frag=a;a=MediaFragments.parse(a);c.extend(c(this).data("smfplayer").mfjson,a);c(this).data("smfplayer").settings.temporalHighlight&&c(b.getMeplayer().media).one("timeupdate",b.highlight);return this};this.getMeplayer=function(){return c(this).data("smfplayer").smfplayer};this.getOptions=function(){return c(this).data("smfplayer").settings};this.getDomObject=function(){return c(this).data("smfplayer").smfplayer.domNode};
return this.each(function(){var a=c(this);if(a.data("smfplayer")===undefined){var d=c.extend({},m,g);if(d.mfURI===undefined){console.error("mfURI cannot be null!");return false}var h=MediaFragments.parseMediaFragmentsUri(d.mfURI);d.success=function(f,k){if(d.autoStart===true)if(f.pluginType=="flash")f.addEventListener("canplay",function(){f.play();if(c(b).data("smfplayer")===undefined)setTimeout(function(){var l=q(c(b).data("smfplayer").mfjson);b.setPosition(l.st*1E3);!c.isEmptyObject(l.xywh)&&c(b).data("smfplayer").settings.spatialEnabled===
true&&b.showxywh(l.xywh)},100);else{var n=q(c(b).data("smfplayer").mfjson);b.setPosition(n.st*1E3);!c.isEmptyObject(n.xywh)&&c(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(n.xywh)}},false);else{f.play();if(c(b).data("smfplayer")===undefined)setTimeout(function(){var n=q(c(b).data("smfplayer").mfjson);b.setPosition(n.st*1E3);!c.isEmptyObject(n.xywh)&&c(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(n.xywh)},100);else{var o=q(c(b).data("smfplayer").mfjson);b.setPosition(o.st*
1E3);!c.isEmptyObject(o.xywh)&&c(b).data("smfplayer").settings.spatialEnabled===true&&b.showxywh(o.xywh)}}f.addEventListener("timeupdate",function(){var n=f.currentTime,l=c(b).data("smfplayer");if(l!==undefined){var p=q(l.mfjson),s=p.st,t=p.et;p=p.xywh;if(n<t&&n>s){if(l!==undefined)if(!c.isEmptyObject(p)&&l.settings.spatialEnabled===true)if(l.settings.xywhoverlay===undefined||!l.settings.xywhoverlay.is(":visible"))b.showxywh(p);if(l.setPositionLock===true)l.setPositionLock=false}else{l.settings.xywhoverlay!==
undefined&&l.settings.xywhoverlay.is(":visible")&&b.hidexywh();if(l.mfreplay===true||d.mfAlwaysEnabled===true)if(n>t){f.pause();b.setPosition(t*1E3);l.mfreplay=false}else if(n<s)if(l.setPositionLock===false){b.setPosition(s*1E3);l.setPositionLock=true}}}},false);d.temporalHighlight&&c(f).one("timeupdate",b.highlight);f.addEventListener("play",function(){var n=f.currentTime,l=c(b).data("smfplayer");if(l!==undefined){var p=q(l.mfjson),s=p.st;p=p.et;if(l.mfreplay===true)if(n<s){if(l.setPositionLock===
false){b.setPosition(s*1E3);l.setPositionLock=true}}else if(n>p)if(l.setPositionLock===false){b.setPosition(p*1E3);l.setPositionLock=true;f.pause();l.mfreplay=false}}},false);if(g.success!==undefined)return g.success.call(this,f,k)};d.error=function(){if(g.error!==undefined)return g.error.call(this)};var j=d.mfURI;if(!c.isEmptyObject(h.hash)){j=d.mfURI.indexOf("#");j=j!==-1?d.mfURI.substring(0,j):d.mfURI}var e=d.isVideo?c("<video/>"):c("<audio/>");e.prop("width",d.width).prop("height",d.height).prop("preload",
"auto").appendTo(a);j=c("<source/>").prop("src",j).appendTo(e);if(smfplayer.utils.isYouTubeURL(d.mfURI))j.prop("type","video/x-youtube");else if(smfplayer.utils.isDailyMotionURL(d.mfURI))j.prop("type","video/dailymotion");else if(smfplayer.utils.isVimeoURL(d.mfURI))j.prop("type","video/vimeo");else{var i=c.url(d.mfURI).attr("file").toLowerCase().split(".");if(i.length>1)if(i=i[i.length-1].toLowerCase())if(c.inArray(i,smfplayer.utils.videoList)!=-1)j.attr("type","video/"+i);else c.inArray(i,smfplayer.utils.audioList)!=
-1&&j.prop("type","audio/"+i)}c.each(d.tracks,function(f,k){c("<track/>").appendTo(e).prop("srclang",k.srclang).prop("kind",k.kind).prop("type",k.type).prop("src",k.src)});j=new MediaElementPlayer(e.get(0),d);a.data("smfplayer",{target:a,smfplayer:j,settings:d,mfjson:h,mfreplay:true,setPositionLock:false})}})},destroy:function(){return this.each(function(){var g=c(this);g.data("smfplayer");c(window).unbind(".smfplayer");g.removeData("smfplayer");g.empty()})}},q=function(g){var b=0,a=smfplayer.utils.durationMax;
if(!c.isEmptyObject(g.hash.t)){a=smfplayer.utils.getTemporalMF(g.hash.t[0]);b=a.st;a=a.et}var d={};c.isEmptyObject(g.hash.xywh)||(d=g.hash.xywh[0]);return{st:b,et:a,xywh:d}};c.fn.smfplayer=function(g){if(r[g])return r[g].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof g==="object"||!g)return r.init.apply(this,arguments);else c.error("Method "+g+" does not exist on jQuery.smfplayer")}})(jQuery);
